<div class="card-container">
  <div class="message-header d-flex align-items-center mb-3">
    <img src="<%= @message.user&.profile_picture || 'default_profile.png' %>" alt="<%= @message.user&.username || 'Anonīms' %>'s profile picture" class="rounded-circle me-2" style="width: 50px; height: 50px;">
    <span class="fw-bold"><%= @message.user&.username || 'Anonīms' %></span>

    <div class="nav-item dropdown ms-auto">
      <a class="fa-solid fa-ellipsis nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"></a>
      <ul class="dropdown-menu">
        <li><%= link_to 'Rediģēt ziņu', edit_message_path(@message), class: 'dropdown-item btn btn-primary' %></li>
        <li><hr class="dropdown-divider"></li>
        <li><%= button_to 'Dzēst ziņu', message_path(@message), method: :delete, data: { confirm: 'Vai tiešām vēlaties dzēst?' }, class: 'dropdown-item btn btn-danger', "data-turbolinks" => false %></li>
      </ul>
    </div>
  </div>

  <p class="message-content"><%= @message.content %></p>

  <% if @message.file.attached? %>
    <div class="message-media">
      <% if @message.file.content_type.start_with?('image/') %>
        <%= image_tag @message.file, alt: 'Pievienota bilde' %>
      <% elsif @message.file.content_type.start_with?('video/') %>
        <video width="100%" controls>
          <source src="<%= url_for(@message.file) %>" type="<%= @message.file.content_type %>">
          Jūsu pārlūkprogramma neatbalsta video tagu.
        </video>
      <% else %>
        <%= link_to 'Download File', rails_blob_path(@message.file, disposition: 'attachment') %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="card-container">
  <div class="reply-form">
    <div id="replyFilePreview" class="file-preview"></div>
    <%= form_with model: [@message, @message.replies.build], local: true do |form| %>
      <div class="input-container">
        <%= form.text_field :content, placeholder: "Ievadiet savu atbildi šeit...", autocomplete: "off", class: "form-control", id: "replyInputField" %>
        
        <label class="file-upload">
          <i class="fas fa-paperclip"></i>
          <%= form.file_field :file, id: "replyFileInput", onchange: "displayReplyFileName()" %>
        </label>
        <button><i class="fas fa-paper-plane"></i></button>
      </div>
    <% end %>
  </div>

  <hr>

  <div class="replies">
    <h4>Komenti:</h4>
    <ul class="reply-list">
      <% @message.replies.each do |reply| %>
        <% if reply.id.present? %>
          <li>
            <div class="reply-header d-flex align-items-center mb-2">
              <img src="<%= reply.user&.profile_picture || 'default_profile.png' %>" alt="<%= reply.user&.username || 'Anonīms' %>'s profile picture" class="rounded-circle me-2" style="width: 40px; height: 40px;">
              <span class="fw-bold"><%= reply.user&.username || 'Anonīms' %></span>
              <div class="nav-item dropdown ms-auto">
                <a class="fa-solid fa-ellipsis nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"></a>
                <ul class="dropdown-menu">
                  <li><%= link_to 'Rediģēt atbildi', edit_message_reply_path(@message, reply), class: 'dropdown-item btn btn-primary' %></li>
                  <li><%= button_to 'Dzēst atbildi', message_reply_path(@message, reply), method: :delete, data: { confirm: 'Vai tiešām vēlaties dzēst?' }, class: 'dropdown-item btn btn-danger', "data-turbolinks" => false %></li>
                </ul>
              </div>
            </div>

            <p><%= reply.content %></p>
            <% if reply.file.attached? %>
              <div class="reply-file">
                <% if reply.file.content_type.start_with?('image/') %>
                  <%= image_tag reply.file, alt: 'Nolādētā bilde' %>
                <% elsif reply.file.content_type.start_with?('video/') %>
                  <video width="100%" controls>
                    <source src="<%= url_for(reply.file) %>" type="<%= reply.file.content_type %>">
                    Jūsu pārlūkprogramma neatbalsta video tagu. 
                  </video>
                <% else %>
                  <%= link_to 'Nolādēt failu', rails_blob_path(reply.file, disposition: 'attachment') %>
                <% end %>
              </div>
            <% end %>
          </li>
        <% end %>
      <% end %>
    </ul>
  </div>
</div>
